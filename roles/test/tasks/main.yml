#- name: Check freespace
#  shell: df /run --output\=avail | tail -1
#  register: check_freespace
#      
#- fail:
#   msg: /run does not have the minimum space required to continue (3Gb requested). 
#  when: check_freespace.stdout lt 3000000
##########
#- name: Test disk space available
#  assert:
#    that:
#        - item.mount != '/' or {{ item.mount == '/' and item.size_available > (item.size_total|float * 0.4) }}
#  with_items: '{{ ansible_mounts }}'
#  ignore_errors: yes
#  register: disk_free
########
#- name: Check /tmp freespace
#  shell: df -BM {{ tmppath }} | awk '{print $4}' | tail -n 1 | cut -d'M' -f1
#  register: disk_free
#
#- name: Check /root freespace
#  shell: df -BM {{ tmppath2 }} | awk '{print $4}' | tail -n 1 | cut -d'M' -f1
#  register: disk_free2
#
#- debug: var=disk_free.stdout
#- debug: var=disk_free2.stdout
#
#- name: Fail when disk space needs attention
#  fail:
#      msg: "Disk space needs attention.\nFree {{disk_free.stdout}}/800M and Free {{disk_free2.stdout}}/800M"
#  when: 'disk_free.stdout | int < 800 and disk_free2.stdout | int < 800'

- name: Check /tmp freespace
  shell: df -BM {{ tmppath }} | awk '{print $4}' | tail -n 1 | cut -d'M' -f1
  register: disk_free

- name: Check /root freespace
  shell: df -BM {{ tmppath2 }} | awk '{print $4}' | tail -n 1 | cut -d'M' -f1
  register: disk_free2

- name: Set filesystem {{ tmppath }} 
  set_fact:
   tmppath_finale: "{{tmppath}}"
  when: 'disk_free.stdout | int > 800'

- name: Set filesystem {{ tmppath2 }}
  set_fact:
   tmppath_finale: "{{tmppath2}}"
  when: 'disk_free2.stdout | int > 800 and disk_free.stdout | int < 800'

- debug: var=tmppath
- debug: var=disk_free.stdout
- debug: var=tmppath2
- debug: var=disk_free2.stdout
- debug: var=tmppath_finale

- name: Fail when disk space needs attention
  fail:
      msg: "Disk space needs attention.\nFree {{disk_free.stdout}}/800M and Free {{disk_free2.stdout}}/800M"
  when: 'disk_free.stdout | int < 800 and disk_free2.stdout | int < 800'
